<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Xively-rickshaw : Some example time series graphs generated from Xively using Rickshaw" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    <link type="text/css" rel="stylesheet" href="css/graph.css">
    <link type="text/css" rel="stylesheet" href="css/detail.css">
    <link type="text/css" rel="stylesheet" href="css/legend.css">
    <link type="text/css" rel="stylesheet" href="css/lines.css">

    <script src="vendor/d3.min.js"></script>
    <script src="vendor/d3.layout.min.js"></script>

    <script src="rickshaw.min.js"></script>
    <script src="vendor/moment.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.min.js"></script>
    <script src="http://d23cj0cdvyoxg0.cloudfront.net/xivelyjs-1.0.3.min.js"></script>  

    <title>AirQualityEgg NO2</title>
  </head>

  <body>

<style type="text/css">
  #axis0 {
    position: absolute;
    height: 800px;
    width: 40px;
  }
  #axis1 {
    position: absolute;
    left: 1050px;
    height: 800px;
    width: 40px;
  }
  #chart {
    left: 50px;
    width: 1000px;
    position: absolute;
  }
</style>

<div id="axis0"></div>
<div id="chart"></div>

<script>

// Set your API key first  
xively.setKey( "oAFLQCo3Sq24RAureB0XTfdHtGY1lxKDM8oV90urYuZIF77L" );  
var startOfYesterday = moment().subtract("day", 1).startOf('day');
var endOfYesterday = moment().startOf('day');
console.log(startOfYesterday);
console.log(endOfYesterday);
var query = { 
  start: startOfYesterday.toJSON(), 
  end: endOfYesterday.toJSON(), 
  interval: 60, 
  limit: 1000 
};
var min, max, len, point, scales;

scales = [];


xively.datastream.history( "1961178354", "Battery1", query, loadData);  
function loadData(data) {  
  var unit = data.unit.label;
  var series = [];
  min = Number.MAX_VALUE;
  max = Number.MIN_VALUE;
  
  var filtedData = data.datapoints.filter(function(x) { return ((x.value < 1000)&& (x.value > 3.30)); });            //filter werkt
  for (var i=0; i < filtedData.length; i++ ) {
    var date = moment(filtedData[i].at);
    var value = parseFloat(filtedData[i].value);                              // float werkt
    series[i] = {x: date.unix(), y: value};
    point = series[i];
    min = Math.min(min, point.y);
    max = Math.max(max, point.y);
  }
  scales.push(d3.scale.linear().domain([min, max]).nice());
    
  drawGraph(series, unit);
}
function drawGraph(data, unit) {
  var graph = new Rickshaw.Graph( {
    element: document.querySelector("#chart"),
    //width: 600,
    //height: 300,
    renderer: 'line',
    series: [
      {
        data: data,
        color: '#6060c0',
        name: unit,
        scale: scales[0]
      }
    ]
  } );
  graph.render();
  var hoverDetail = new Rickshaw.Graph.HoverDetail( {
    graph: graph
  } );
  var legend = new Rickshaw.Graph.Legend( {
    graph: graph,
    element: document.getElementById('legend')
  } );
  var shelving = new Rickshaw.Graph.Behavior.Series.Toggle( {
    graph: graph,
    legend: legend
  } );
  var axes = new Rickshaw.Graph.Axis.Time( {
    graph: graph
  });
  axes.render();
  
  
  var yAxis = new Rickshaw.Graph.Axis.Y({
      element: document.getElementById('axis0'),
      graph: graph,
      orientation: 'left',
      scale: scales[0],
      tickFormat: Rickshaw.Fixtures.Number.formatKMBT
  });
  yAxis.render(); 
}

/*
var data = [ { x: 0, y: 40 }, { x: 1, y: 49 }, { x: 2, y: 17 }, { x: 3, y: 42 } ];

  var graph = new Rickshaw.Graph( {
    element: document.querySelector("#chart"),
    width: 400,
    height: 400,
    renderer: 'line',
    series: [ {
            color: 'steelblue',
            data: data
    } ]
  } );
  
  graph.render();

}
*/

</script>


</body>
</body>

